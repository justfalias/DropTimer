---
import MainLayout from '@/components/MainLayout.astro';
import GameCard from '@/components/GameCard.astro';
import GameListItem from '@/components/GameListItem.astro';
import CountdownTimer from '@/components/CountdownTimer.astro';
import type { Game } from '@/types/Game';
import gamesData from '@/data/games.json';

const games: Game[] = gamesData as Game[];

// SEO metadata
const seoTitle = 'My Wishlist - DropTimer.gg';
const seoDescription = 'View all your wishlisted game countdown timers in one place. Track release dates for your most anticipated games.';
const siteUrl = Astro.url.origin;
---

<MainLayout 
  title={seoTitle}
  description={seoDescription}
  image={`${siteUrl}/favicon.svg`}
  canonicalUrl={`${siteUrl}/wishlist`}
>
  <section class="container mx-auto px-4 py-12 md:py-16">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-4xl md:text-5xl font-heading font-bold gradient-text mb-6 text-center">
        My Wishlist
      </h1>
      <p class="text-lg text-text-secondary mb-8 text-center">
        All your wishlisted countdown timers in one place
      </p>

      <!-- View Toggle -->
      <div class="flex items-center justify-center gap-2 mb-8">
        <div class="flex items-center gap-1 bg-dark-card border border-dark-card-hover rounded-lg p-1">
          <button
            type="button"
            id="view-grid-btn"
            class="p-2 rounded transition-colors duration-200"
            title="Grid View"
          >
            <svg class="w-5 h-5 text-neon-cyan" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z" />
            </svg>
          </button>
          <button
            type="button"
            id="view-list-btn"
            class="p-2 rounded transition-colors duration-200 text-text-secondary hover:text-neon-cyan"
            title="List View"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Wishlist Container -->
      <div id="wishlist-container">
        <!-- Grid View -->
        <div id="wishlist-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Will be populated by JavaScript -->
        </div>

        <!-- List View -->
        <div id="wishlist-list" class="hidden space-y-4">
          <!-- Will be populated by JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
          <svg
            class="w-16 h-16 mx-auto mb-4 text-text-secondary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
            />
          </svg>
          <p class="text-text-secondary text-lg mb-4">No wishlisted games yet</p>
          <p class="text-text-secondary/80 mb-6">Start adding games to your wishlist to see them here!</p>
          <a
            href="/"
            class="inline-block px-6 py-3 bg-neon-cyan text-dark-bg rounded-lg font-semibold hover:bg-neon-purple transition-colors"
          >
            Browse Games
          </a>
        </div>
      </div>
    </div>
  </section>
</MainLayout>

<script define:vars={{ gamesData: JSON.stringify(games) }}>
  (function() {
    'use strict';
    
    if (typeof window === 'undefined') return;
    
    console.log('=== WISHLIST PAGE LOADED ===');
    
    // Parse games data
    let allGames = [];
    try {
      allGames = JSON.parse(gamesData);
      console.log('Games loaded:', allGames.length);
    } catch (e) {
      console.error('Error parsing games:', e);
    }

    // Load wishlist from localStorage and Supabase
    async function loadWishlist() {
      try {
        // Try Supabase first
        const userId = localStorage.getItem('droptimer-anonymous-id');
        if (userId) {
          // This would need to fetch from API, for now use localStorage
        }
        
        // Fallback to localStorage
        const wishlist = JSON.parse(localStorage.getItem('droptimer-wishlist') || '[]');
        return new Set(wishlist);
      } catch {
        return new Set();
      }
    }

    // Get wishlisted games
    async function getWishlistedGames() {
      const wishlist = await loadWishlist();
      return allGames.filter(game => wishlist.has(game.slug));
    }

    // Render games
    async function renderGames() {
      const wishlistedGames = await getWishlistedGames();
      const gridView = document.getElementById('wishlist-grid');
      const listView = document.getElementById('wishlist-list');
      const emptyState = document.getElementById('empty-state');
      
      if (!gridView || !listView || !emptyState) {
        console.error('Missing container elements');
        return;
      }

      // Clear containers
      gridView.innerHTML = '';
      listView.innerHTML = '';

      if (wishlistedGames.length === 0) {
        emptyState.classList.remove('hidden');
        gridView.classList.add('hidden');
        listView.classList.add('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      // Render grid view
      wishlistedGames.forEach((game) => {
        const card = document.createElement('div');
        card.className = 'animate-slide-up';
        card.innerHTML = `
          <a href="/${game.slug}" class="group block card-hover" data-astro-prefetch>
            <div class="relative overflow-hidden rounded-lg bg-dark-card border border-dark-card-hover">
              <div class="relative h-64 overflow-hidden">
                <img
                  src="${game.image}"
                  alt="${game.name} cover"
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                  loading="lazy"
                  onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%231a1a2e\' width=\'400\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' fill=\'%23666\' font-family=\'Arial\' font-size=\'18\'%3ENo Image%3C/text%3E%3C/svg%3E';"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-dark-bg via-transparent to-transparent opacity-60"></div>
                <div class="absolute bottom-4 left-4 right-4">
                  <div class="countdown-timer" data-release-date="${game.releaseDate}" data-large="false">
                    <!-- Timer will be initialized by CountdownTimer script -->
                  </div>
                </div>
              </div>
              <div class="p-4 space-y-3">
                <h3 class="text-xl font-heading font-bold text-text-primary group-hover:text-neon-cyan transition-colors">
                  ${game.name}
                </h3>
                <div class="flex flex-wrap gap-2">
                  ${game.platforms.map(platform => {
                    const platformLower = platform.toLowerCase();
                    const platformColors = {
                      'pc': 'bg-platform-pc',
                      'playstation': 'bg-platform-playstation',
                      'xbox': 'bg-platform-xbox',
                      'switch': 'bg-platform-switch',
                      'steam': 'bg-platform-steam'
                    };
                    const colorClass = platformColors[platformLower] || 'bg-gray-600';
                    return `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium ${colorClass} text-white"><img src="/images/platforms/${platformLower}.svg" alt="${platform}" class="w-3 h-3" /><span>${platform}</span></span>`;
                  }).join('')}
                </div>
              </div>
            </div>
          </a>
        `;
        gridView.appendChild(card);
      });

      // Render list view
      wishlistedGames.forEach((game) => {
        const item = document.createElement('div');
        item.className = 'animate-slide-up';
        item.innerHTML = `
          <a href="/${game.slug}" class="group flex items-center gap-6 p-4 bg-dark-card hover:bg-dark-card-hover border border-dark-card-hover rounded-lg transition-all duration-200 card-hover" data-astro-prefetch>
            <div class="relative w-24 h-24 md:w-32 md:h-32 flex-shrink-0 overflow-hidden rounded-lg">
              <img
                src="${game.image}"
                alt="${game.name} cover"
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy"
                onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%231a1a2e\' width=\'200\' height=\'200\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' fill=\'%23666\' font-family=\'Arial\' font-size=\'14\'%3ENo Image%3C/text%3E%3C/svg%3E';"
              />
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-lg md:text-xl font-heading font-bold text-text-primary group-hover:text-neon-cyan transition-colors truncate">
                ${game.name}
              </h3>
              <div class="flex flex-wrap gap-2 mt-2">
                ${game.platforms.map(platform => {
                  const platformLower = platform.toLowerCase();
                  const platformColors = {
                    'pc': 'bg-platform-pc',
                    'playstation': 'bg-platform-playstation',
                    'xbox': 'bg-platform-xbox',
                    'switch': 'bg-platform-switch',
                    'steam': 'bg-platform-steam'
                  };
                  const colorClass = platformColors[platformLower] || 'bg-gray-600';
                  return `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium ${colorClass} text-white"><img src="/images/platforms/${platformLower}.svg" alt="${platform}" class="w-3 h-3" /><span>${platform}</span></span>`;
                }).join('')}
              </div>
            </div>
            <div class="flex-shrink-0">
              <div class="countdown-timer" data-release-date="${game.releaseDate}" data-large="false">
                <!-- Timer will be initialized by CountdownTimer script -->
              </div>
            </div>
          </a>
        `;
        listView.appendChild(item);
      });

      // Initialize timers
      setTimeout(() => {
        const timerElements = document.querySelectorAll('.countdown-timer');
        timerElements.forEach((el) => {
          const releaseDate = el.getAttribute('data-release-date');
          if (releaseDate) {
            // Initialize timer (this will be handled by CountdownTimer component)
          }
        });
      }, 100);
    }

    // View toggle
    function initViewToggle() {
      const gridBtn = document.getElementById('view-grid-btn');
      const listBtn = document.getElementById('view-list-btn');
      const gridView = document.getElementById('wishlist-grid');
      const listView = document.getElementById('wishlist-list');
      
      if (!gridBtn || !listBtn || !gridView || !listView) {
        console.error('Missing view toggle elements');
        return;
      }

      function setView(view) {
        if (view === 'grid') {
          gridView.classList.remove('hidden');
          listView.classList.add('hidden');
          gridBtn.classList.add('text-neon-cyan');
          gridBtn.classList.remove('text-text-secondary');
          listBtn.classList.remove('text-neon-cyan');
          listBtn.classList.add('text-text-secondary');
        } else {
          gridView.classList.add('hidden');
          listView.classList.remove('hidden');
          listBtn.classList.add('text-neon-cyan');
          listBtn.classList.remove('text-text-secondary');
          gridBtn.classList.remove('text-neon-cyan');
          gridBtn.classList.add('text-text-secondary');
        }
        localStorage.setItem('droptimer-view', view);
      }

      setView(localStorage.getItem('droptimer-view') || 'grid');
      
      gridBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        setView('grid');
      });
      
      listBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        setView('list');
      });
    }

    // Initialize
    function init() {
      console.log('=== INITIALIZING WISHLIST PAGE ===');
      renderGames();
      initViewToggle();
      console.log('=== INITIALIZATION COMPLETE ===');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(init, 100);
      });
    } else {
      setTimeout(init, 100);
    }

    // Re-initialize on Astro page load
    document.addEventListener('astro:page-load', function() {
      console.log('Astro page loaded, re-initializing...');
      setTimeout(init, 50);
    });
  })();
</script>

