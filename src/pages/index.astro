---
import MainLayout from '@/components/MainLayout.astro';
import GameCard from '@/components/GameCard.astro';
import GameListItem from '@/components/GameListItem.astro';
import type { Game } from '@/types/Game';
import gamesData from '@/data/games.json';

// Load games data
const games: Game[] = gamesData as Game[];

// Sort games by release date (soonest first)
const sortedGames = [...games].sort((a, b) => {
  return new Date(a.releaseDate).getTime() - new Date(b.releaseDate).getTime();
});

// SEO metadata
const seoTitle = 'DropTimer.gg - Track Upcoming Game Releases & Countdown Timers';
const seoDescription = `Track ${sortedGames.length} upcoming video game releases with live countdown timers. Find release dates for PC, PlayStation, Xbox, Switch, and Steam games. Never miss a game launch again!`;
const siteUrl = Astro.url.origin;

// JSON-LD for homepage
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "DropTimer.gg",
  "url": siteUrl,
  "description": seoDescription,
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": `${siteUrl}/?search={search_term_string}`
    },
    "query-input": "required name=search_term_string"
  },
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": sortedGames.slice(0, 10).map((game, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "item": {
        "@type": "VideoGame",
        "name": game.name,
        "url": `${siteUrl}/${game.slug}`,
        "image": game.image.startsWith('http') ? game.image : `${siteUrl}${game.image}`,
        "description": game.description,
        "gamePlatform": game.platforms,
        "datePublished": game.releaseDate
      }
    }))
  }
};
---

<MainLayout 
  title={seoTitle}
  description={seoDescription}
  image={`${siteUrl}/favicon.svg`}
  canonicalUrl={siteUrl}
  jsonLd={jsonLd}
>
  <!-- Hero Search Section -->
  <section class="container mx-auto px-4 py-12 md:py-16">
    <div class="max-w-4xl mx-auto text-center mb-12">
      <h1 class="text-4xl md:text-5xl lg:text-6xl font-heading font-bold gradient-text mb-6 animate-fade-in">
        DropTimer<span class="text-neon-cyan">.gg</span>
      </h1>
      <p class="text-lg md:text-xl text-text-secondary mb-8 animate-fade-in" style="animation-delay: 0.1s;">
        Track countdowns for all upcoming game releases
      </p>

      <!-- Main Search Input with Autocomplete -->
      <div class="relative max-w-2xl mx-auto mb-6 animate-fade-in" style="animation-delay: 0.2s; z-index: 1000;">
        <input
          type="text"
          id="main-search-input"
          placeholder="Search games..."
          autocomplete="off"
          class="w-full px-6 py-4 pl-14 text-lg bg-dark-card border-2 border-dark-card-hover rounded-lg text-text-primary placeholder-text-secondary focus:outline-none focus:border-neon-cyan transition-all duration-200 relative z-10"
        />
        <!-- Autocomplete Dropdown -->
        <div id="autocomplete-dropdown" class="hidden absolute top-full left-0 right-0 mt-2 bg-dark-card border-2 border-dark-card-hover rounded-lg shadow-xl z-[10000] max-h-64 overflow-y-auto">
        </div>
        <svg
          class="absolute left-5 top-1/2 -translate-y-1/2 w-6 h-6 text-text-secondary pointer-events-none z-20"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
        <button
          id="main-clear-search"
          class="absolute right-5 top-1/2 -translate-y-1/2 hidden text-text-secondary hover:text-neon-cyan transition-colors"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Sort and View Toggle -->
      <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-6 animate-fade-in" style="animation-delay: 0.3s; position: relative; z-index: 1;">
        <!-- Sort Options -->
        <div class="flex items-center gap-2 bg-dark-card border border-dark-card-hover rounded-lg p-1">
          <span class="text-xs text-text-secondary px-2">Sort:</span>
          <button
            type="button"
            id="sort-release-btn"
            class="px-3 py-1.5 rounded text-sm transition-colors duration-200 text-neon-cyan bg-neon-cyan/10"
            data-sort="release"
            title="Sort by Release Date"
          >
            Release
          </button>
          <button
            type="button"
            id="sort-wishlist-btn"
            class="px-3 py-1.5 rounded text-sm transition-colors duration-200 text-text-secondary hover:text-neon-cyan"
            data-sort="wishlist"
            title="Sort by Most Wishlisted"
          >
            Most Wishlisted
          </button>
        </div>

        <!-- Filter Options -->
        <div class="flex items-center gap-2 bg-dark-card border border-dark-card-hover rounded-lg p-1">
          <span class="text-xs text-text-secondary px-2">Filter:</span>
          <button
            type="button"
            id="filter-all-btn"
            class="px-3 py-1.5 rounded text-sm transition-colors duration-200 text-neon-cyan bg-neon-cyan/10"
            data-filter="all"
            title="Show All Games"
          >
            All
          </button>
          <button
            type="button"
            id="filter-wishlist-btn"
            class="px-3 py-1.5 rounded text-sm transition-colors duration-200 text-text-secondary hover:text-neon-cyan"
            data-filter="wishlist"
            title="Show My Wishlist"
          >
            My Wishlist
          </button>
        </div>

        <!-- View Toggle -->
        <div class="flex items-center gap-1 bg-dark-card border border-dark-card-hover rounded-lg p-1">
          <button
            type="button"
            id="view-grid-btn"
            class="p-2 rounded transition-all duration-200 bg-neon-cyan/20 text-neon-cyan"
            title="Grid View"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z" />
            </svg>
          </button>
          <button
            type="button"
            id="view-list-btn"
            class="p-2 rounded transition-all duration-200 text-text-secondary hover:text-neon-cyan hover:bg-dark-card-hover"
            title="List View"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Games Section -->
  <section id="games-section" class="container mx-auto px-4 pb-12 md:pb-16">
    <!-- Results Count -->
    <div id="results-count" class="mb-6 text-center">
      <p class="text-text-secondary">
        <span id="results-number">{sortedGames.length}</span> game{sortedGames.length !== 1 ? 's' : ''} found
      </p>
    </div>

    <!-- Games Container -->
    <div id="games-container">
      <!-- Grid View -->
      <div id="games-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {sortedGames.map((game, index) => (
        <div
          class="animate-slide-up"
          style={`animation-delay: ${index * 0.1}s; animation-fill-mode: both;`}
            data-game-name={game.name.toLowerCase()}
            data-game-slug={game.slug}
            data-platforms={game.platforms.join(',')}
        >
          <GameCard game={game} />
        </div>
      ))}
    </div>

      <!-- List View -->
      <div id="games-list" class="hidden space-y-4">
        {sortedGames.map((game, index) => (
          <div
            class="animate-slide-up"
            style={`animation-delay: ${index * 0.05}s; animation-fill-mode: both;`}
            data-game-name={game.name.toLowerCase()}
            data-game-slug={game.slug}
            data-platforms={game.platforms.join(',')}
          >
            <GameListItem game={game} />
          </div>
        ))}
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-16">
      <svg
        class="w-16 h-16 mx-auto mb-4 text-text-secondary"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <p class="text-text-secondary text-lg">No games found matching your search.</p>
      <button
        id="clear-filters-btn"
        class="mt-4 text-neon-cyan hover:text-neon-purple transition-colors"
      >
        Clear filters
      </button>
    </div>

    {sortedGames.length === 0 && (
      <div class="text-center py-16">
        <p class="text-text-secondary text-lg">No upcoming games found.</p>
      </div>
    )}
  </section>
</MainLayout>

<!-- Games data as JSON for JavaScript -->
<script type="application/json" id="games-json-data" set:html={JSON.stringify({ gamesData: games })}></script>

<!-- Homepage JavaScript -->
<script src="/scripts/homepage.js" defer></script>
<script src="/scripts/social.js" defer></script>
