---
import MainLayout from '@/components/MainLayout.astro';
import PlatformTag from '@/components/PlatformTag.astro';
import CountdownTimer from '@/components/CountdownTimer.astro';
import type { Game } from '@/types/Game';
import gamesData from '@/data/games.json';

// Export getStaticPaths to tell Astro which slugs to pre-render
export async function getStaticPaths() {
  const games: Game[] = gamesData as Game[];
  
  return games.map((game) => ({
    params: { slug: game.slug },
    props: { game },
  }));
}

const { slug } = Astro.params;
const game = Astro.props.game || (gamesData as Game[]).find((g) => g.slug === slug);

if (!game) {
  return Astro.redirect('/404');
}

// Helper function to get release date for a platform
function getReleaseDateForPlatform(game: Game, platform?: string): string {
  if (platform && game.platformReleaseDates && game.platformReleaseDates[platform as keyof typeof game.platformReleaseDates]) {
    return game.platformReleaseDates[platform as keyof typeof game.platformReleaseDates]!;
  }
  return game.releaseDate;
}

// Get the earliest release date for display
function getEarliestReleaseDate(game: Game): string {
  if (game.platformReleaseDates && Object.keys(game.platformReleaseDates).length > 0) {
    const dates = Object.values(game.platformReleaseDates).filter(Boolean) as string[];
    if (dates.length > 0) {
      return dates.sort()[0];
    }
  }
  return game.releaseDate;
}

const defaultReleaseDate = getEarliestReleaseDate(game);
const releaseDateFormatted = new Date(defaultReleaseDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const shareUrl = `${Astro.url.origin}/${game.slug}`;
---

<MainLayout title={`${game.name} - DropTimer.gg`} description={game.description}>
  <div class="min-h-screen flex flex-col relative">
    <!-- Fixed Background Image -->
    <div class="fixed inset-0 z-0">
      <img
        src={game.image}
        alt={`${game.name} cover`}
        class="w-full h-full object-cover"
        loading="eager"
      />
      <!-- Gradient Overlay Layers -->
      <div class="absolute inset-0 bg-gradient-to-b from-dark-bg via-dark-bg/60 to-dark-bg"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-dark-bg via-transparent to-transparent"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-dark-bg/40 via-transparent to-dark-bg/40"></div>
    </div>

    <!-- Hero Section with Timer -->
    <section class="flex-1 flex items-center justify-center px-4 py-12 md:py-16 relative z-10 min-h-screen">

      <!-- Content -->
      <div class="container mx-auto text-center">
        <!-- Game Title -->
        <h1 class="text-4xl md:text-6xl lg:text-7xl font-heading font-bold gradient-text mb-8 animate-fade-in">
          {game.name}
        </h1>

        <!-- Platform Selector (if multiple platforms with different dates) -->
        {game.platformReleaseDates && Object.keys(game.platformReleaseDates).length > 1 && (
          <div class="mb-6 animate-fade-in" style="animation-delay: 0.15s;">
            <p class="text-sm text-text-secondary mb-3">Select Platform:</p>
            <div class="flex flex-wrap items-center justify-center gap-3">
              {game.platforms.map((platform) => {
                const platformDate = game.platformReleaseDates?.[platform];
                const dateStr = platformDate 
                  ? new Date(platformDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                  : new Date(game.releaseDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                return (
                  <button
                    class="platform-select-btn px-4 py-2 rounded-lg bg-dark-card/50 hover:bg-dark-card border border-dark-card-hover text-text-secondary hover:text-neon-cyan transition-all duration-200 text-sm"
                    data-platform={platform}
                    data-release-date={platformDate || game.releaseDate}
                  >
                    {platform} - {dateStr}
                  </button>
                );
              })}
            </div>
          </div>
        )}

        <!-- Large Countdown Timer -->
        <div class="mb-12 animate-fade-in" style="animation-delay: 0.2s;">
          <CountdownTimer releaseDate={defaultReleaseDate} large={true} id="main-countdown" />
        </div>

        <!-- Release Date -->
        <p id="release-date-display" class="text-xl md:text-2xl text-text-secondary mb-8 font-mono animate-fade-in" style="animation-delay: 0.4s;">
          {releaseDateFormatted}
        </p>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8 animate-fade-in" style="animation-delay: 0.6s;">
          <!-- Favorite Button -->
          <button
            id="favorite-btn"
            class="flex items-center gap-2 px-6 py-3 bg-dark-card hover:bg-dark-card-hover border border-dark-card-hover rounded-lg transition-all duration-200 text-text-primary hover:text-neon-cyan group"
            data-game-slug={game.slug}
          >
            <svg
              id="favorite-icon"
              class="w-5 h-5 transition-all duration-200"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
              />
            </svg>
            <span id="favorite-text">Add to Favorites</span>
          </button>

          <!-- Share Button -->
          <button
            id="share-btn"
            class="flex items-center gap-2 px-6 py-3 bg-dark-card hover:bg-dark-card-hover border border-dark-card-hover rounded-lg transition-all duration-200 text-text-primary hover:text-neon-cyan group"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
              />
            </svg>
            Share
          </button>
        </div>

        <!-- Platforms -->
        <div class="flex flex-wrap items-center justify-center gap-3 mb-8 animate-fade-in" style="animation-delay: 0.8s;">
          {game.platforms.map((platform) => (
            <PlatformTag platform={platform} />
          ))}
        </div>

        <!-- Back to Home -->
        <a
          href="/"
          class="inline-flex items-center gap-2 text-text-secondary hover:text-neon-cyan transition-colors duration-200 text-sm animate-fade-in"
          style="animation-delay: 1s;"
          data-astro-prefetch
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          Back to Games
        </a>
      </div>
    </section>
  </div>
</MainLayout>

<script define:vars={{ gameSlug: game.slug, shareUrl, gameData: JSON.stringify(game) }}>
  // Platform selector functionality
  function initPlatformSelector() {
    const platformButtons = document.querySelectorAll('.platform-select-btn');
    const countdownTimer = document.getElementById('main-countdown');
    const releaseDateDisplay = document.getElementById('release-date-display');
    const game = JSON.parse(gameData);
    
    if (platformButtons.length === 0) return;
    
    // Set first platform as active by default
    if (platformButtons.length > 0) {
      platformButtons[0].classList.add('bg-neon-cyan/20', 'border-neon-cyan', 'text-neon-cyan');
      platformButtons[0].classList.remove('bg-dark-card/50', 'text-text-secondary');
    }
    
    platformButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const platform = btn.getAttribute('data-platform');
        const releaseDate = btn.getAttribute('data-release-date');
        
        if (!releaseDate) return;
        
        // Update active button
        platformButtons.forEach(b => {
          b.classList.remove('bg-neon-cyan/20', 'border-neon-cyan', 'text-neon-cyan');
          b.classList.add('bg-dark-card/50', 'text-text-secondary');
        });
        btn.classList.add('bg-neon-cyan/20', 'border-neon-cyan', 'text-neon-cyan');
        btn.classList.remove('bg-dark-card/50', 'text-text-secondary');
        
        // Update countdown timer
        if (countdownTimer) {
          const timerElement = countdownTimer.querySelector('[data-release-date]');
          if (timerElement) {
            timerElement.setAttribute('data-release-date', releaseDate);
            // Trigger update
            const event = new CustomEvent('updateTimer', { detail: { releaseDate } });
            window.dispatchEvent(event);
          }
        }
        
        // Update release date display
        if (releaseDateDisplay) {
          const date = new Date(releaseDate);
          releaseDateDisplay.textContent = date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
        }
      });
    });
  }

  // Favorite functionality
  function initFavorites() {
    const favoriteBtn = document.getElementById('favorite-btn');
    const favoriteIcon = document.getElementById('favorite-icon');
    const favoriteText = document.getElementById('favorite-text');
    
    if (!favoriteBtn || !favoriteIcon || !favoriteText) return;

    // Load favorites from localStorage
    function loadFavorites() {
      try {
        const favorites = JSON.parse(localStorage.getItem('droptimer-favorites') || '[]');
        return new Set(favorites);
      } catch {
        return new Set();
      }
    }

    // Save favorites to localStorage
    function saveFavorites(favorites) {
      localStorage.setItem('droptimer-favorites', JSON.stringify(Array.from(favorites)));
    }

    // Check if game is favorited
    const favorites = loadFavorites();
    const isFavorited = favorites.has(gameSlug);
    
    // Update button state
    function updateButtonState(favorited) {
      if (favorited) {
        favoriteIcon.classList.add('fill-neon-cyan', 'text-neon-cyan');
        favoriteText.textContent = 'Favorited';
      } else {
        favoriteIcon.classList.remove('fill-neon-cyan', 'text-neon-cyan');
        favoriteText.textContent = 'Add to Favorites';
      }
    }

    updateButtonState(isFavorited);

    // Toggle favorite on click
    favoriteBtn.addEventListener('click', () => {
      const currentFavorites = loadFavorites();
      
      if (currentFavorites.has(gameSlug)) {
        currentFavorites.delete(gameSlug);
        updateButtonState(false);
      } else {
        currentFavorites.add(gameSlug);
        updateButtonState(true);
      }
      
      saveFavorites(currentFavorites);
    });
  }

  // Share functionality
  function initShare() {
    const shareBtn = document.getElementById('share-btn');
    if (!shareBtn) return;

    shareBtn.addEventListener('click', async () => {
      const shareData = {
        title: document.title,
        text: `Check out the countdown for ${document.querySelector('h1')?.textContent || 'this game'}!`,
        url: shareUrl,
      };

      try {
        // Try Web Share API first (mobile)
        if (navigator.share) {
          await navigator.share(shareData);
        } else {
          // Fallback: Copy to clipboard
          await navigator.clipboard.writeText(shareUrl);
          const originalText = shareBtn.innerHTML;
          shareBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copied!';
          setTimeout(() => {
            shareBtn.innerHTML = originalText;
          }, 2000);
        }
      } catch (err) {
        // User cancelled or error occurred
        if (err.name !== 'AbortError') {
          console.error('Error sharing:', err);
        }
      }
    });
  }

  // Initialize on page load
  if (typeof window !== 'undefined') {
    initPlatformSelector();
    initFavorites();
    initShare();
  }
</script>
