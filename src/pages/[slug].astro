---
import MainLayout from '@/components/MainLayout.astro';
import PlatformTag from '@/components/PlatformTag.astro';
import CountdownTimer from '@/components/CountdownTimer.astro';
import type { Game } from '@/types/Game';
import gamesData from '@/data/games.json';

// Export getStaticPaths to tell Astro which slugs to pre-render
export async function getStaticPaths() {
  const games: Game[] = gamesData as Game[];
  
  return games.map((game) => ({
    params: { slug: game.slug },
    props: { game },
  }));
}

const { slug } = Astro.params;
const game = Astro.props.game || (gamesData as Game[]).find((g) => g.slug === slug);

if (!game) {
  return Astro.redirect('/404');
}

// Helper function to get release date for a platform
function getReleaseDateForPlatform(game: Game, platform?: string): string {
  if (platform && game.platformReleaseDates && game.platformReleaseDates[platform as keyof typeof game.platformReleaseDates]) {
    return game.platformReleaseDates[platform as keyof typeof game.platformReleaseDates]!;
  }
  return game.releaseDate;
}

// Get the earliest release date for display
function getEarliestReleaseDate(game: Game): string {
  if (game.platformReleaseDates && Object.keys(game.platformReleaseDates).length > 0) {
    const dates = Object.values(game.platformReleaseDates).filter(Boolean) as string[];
    if (dates.length > 0) {
      return dates.sort()[0];
    }
  }
  return game.releaseDate;
}

const defaultReleaseDate = getEarliestReleaseDate(game);
const releaseDateFormatted = new Date(defaultReleaseDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const siteUrl = Astro.url.origin;
const gameUrl = `${siteUrl}/${game.slug}`;
const shareUrl = gameUrl; // Alias for compatibility with script
const gameImage = game.image.startsWith('http') ? game.image : `${siteUrl}${game.image}`;

// SEO metadata
const seoTitle = `${game.name} Release Date & Countdown - DropTimer.gg`;
const seoDescription = `${game.name} releases on ${releaseDateFormatted} for ${game.platforms.join(', ')}. Track the countdown timer and never miss the launch! ${game.description}`;

// JSON-LD Structured Data for VideoGame
const jsonLd: any = {
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": game.name,
  "description": game.description,
  "image": gameImage,
  "url": gameUrl,
  "gamePlatform": game.platforms.map(platform => {
    const platformMap: Record<string, string> = {
      'PC': 'PC',
      'PlayStation': 'PlayStation',
      'Xbox': 'Xbox',
      'Switch': 'Nintendo Switch',
      'Steam': 'Steam'
    };
    return platformMap[platform] || platform;
  }),
  "datePublished": defaultReleaseDate,
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.5",
    "ratingCount": "1"
  },
  "offers": {
    "@type": "Offer",
    "availability": "https://schema.org/PreOrder",
    "price": "0",
    "priceCurrency": "USD"
  }
};

// Add platform-specific release dates if available
if (game.platformReleaseDates && Object.keys(game.platformReleaseDates).length > 0) {
  jsonLd["hasVariant"] = Object.entries(game.platformReleaseDates).map(([platform, date]) => ({
    "@type": "VideoGame",
    "name": `${game.name} (${platform})`,
    "gamePlatform": platform,
    "datePublished": date
  }));
}
---

<MainLayout 
  title={seoTitle}
  description={seoDescription}
  image={gameImage}
  type="article"
  canonicalUrl={gameUrl}
  jsonLd={jsonLd}
>
  <div class="min-h-screen flex flex-col relative">
    <!-- Fixed Background Image -->
    <div class="fixed inset-0 z-0">
      <img
        src={game.image}
        alt={`${game.name} cover`}
        class="w-full h-full object-cover"
        loading="eager"
      />
      <!-- Gradient Overlay Layers -->
      <div class="absolute inset-0 bg-gradient-to-b from-dark-bg via-dark-bg/60 to-dark-bg"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-dark-bg via-transparent to-transparent"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-dark-bg/40 via-transparent to-dark-bg/40"></div>
    </div>

    <!-- Hero Section with Timer -->
    <section class="flex-1 flex items-center justify-center px-4 py-12 md:py-16 relative z-10 min-h-screen">

      <!-- Content -->
      <div class="container mx-auto text-center">
        <!-- Game Title -->
        <h1 class="text-4xl md:text-6xl lg:text-7xl font-heading font-bold gradient-text mb-8 animate-fade-in">
          {game.name}
        </h1>

        <!-- Platform Selector (if multiple platforms with different dates) -->
        {game.platformReleaseDates && Object.keys(game.platformReleaseDates).length > 1 && (
          <div class="mb-6 animate-fade-in" style="animation-delay: 0.15s;">
            <p class="text-sm text-text-secondary mb-3">Select Platform:</p>
            <div class="flex flex-wrap items-center justify-center gap-3">
              {game.platforms.map((platform) => {
                const platformDate = game.platformReleaseDates?.[platform];
                const dateStr = platformDate 
                  ? new Date(platformDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                  : new Date(game.releaseDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                return (
                  <button
                    class="platform-select-btn px-4 py-2 rounded-lg bg-dark-card/50 hover:bg-dark-card border border-dark-card-hover text-text-secondary hover:text-neon-cyan transition-all duration-200 text-sm"
                    data-platform={platform}
                    data-release-date={platformDate || game.releaseDate}
                  >
                    {platform} - {dateStr}
                  </button>
                );
              })}
            </div>
          </div>
        )}

        <!-- Large Countdown Timer -->
        <div class="mb-12 animate-fade-in" style="animation-delay: 0.2s;">
          <CountdownTimer releaseDate={defaultReleaseDate} large={true} id="main-countdown" />
        </div>

        <!-- Release Date -->
        <p id="release-date-display" class="text-xl md:text-2xl text-text-secondary mb-8 font-mono animate-fade-in" style="animation-delay: 0.4s;">
          {releaseDateFormatted}
        </p>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8 animate-fade-in" style="animation-delay: 0.6s;">
          <!-- Wishlist Button -->
          <button
            id="wishlist-btn"
            class="flex items-center gap-2 px-6 py-3 bg-dark-card hover:bg-dark-card-hover border border-dark-card-hover rounded-lg transition-all duration-200 text-text-primary hover:text-neon-purple group"
            data-game-slug={game.slug}
          >
            <svg
              id="wishlist-icon"
              class="w-5 h-5 transition-all duration-200"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
              />
            </svg>
            <span id="wishlist-text">Add to Wishlist</span>
            <span id="wishlist-count" class="text-xs text-text-secondary ml-1">(<span data-count>0</span>)</span>
          </button>

          <!-- Share Button -->
          <button
            id="share-btn"
            class="flex items-center gap-2 px-6 py-3 bg-dark-card hover:bg-dark-card-hover border border-dark-card-hover rounded-lg transition-all duration-200 text-text-primary hover:text-neon-cyan group"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
              />
            </svg>
            Share
          </button>

          <!-- Embed Button -->
          <button
            id="embed-btn"
            class="flex items-center gap-2 px-6 py-3 bg-neon-cyan hover:bg-neon-purple text-dark-bg rounded-lg transition-all duration-200 font-semibold group"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
            Embed
          </button>
        </div>

        <!-- Embed Modal -->
        <div id="embed-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div class="bg-dark-card border-2 border-dark-card-hover rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-heading font-bold text-text-primary">Embed Countdown Widget</h2>
                <button
                  id="close-embed-modal"
                  class="text-text-secondary hover:text-neon-cyan transition-colors"
                >
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <!-- Preview -->
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-text-primary mb-3">Preview</h3>
                <div class="bg-dark-surface p-4 rounded-lg border border-dark-card-hover">
                  <iframe
                    id="embed-preview"
                    src={`${gameUrl.replace('/' + game.slug, '/embed/' + game.slug)}?size=medium&theme=dark`}
                    class="w-full border-0 rounded"
                    style="min-height: 300px;"
                    loading="lazy"
                  ></iframe>
                </div>
              </div>

              <!-- Options -->
              <div class="mb-6 space-y-4">
                <div>
                  <label class="block text-sm font-medium text-text-primary mb-2">Size</label>
                  <select id="embed-size" class="w-full px-4 py-2 bg-dark-surface border border-dark-card-hover rounded-lg text-text-primary">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-text-primary mb-2">Theme</label>
                  <select id="embed-theme" class="w-full px-4 py-2 bg-dark-surface border border-dark-card-hover rounded-lg text-text-primary">
                    <option value="dark" selected>Dark</option>
                    <option value="light">Light</option>
                    <option value="neon">Neon</option>
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="embed-title" checked class="w-4 h-4 rounded border-dark-card-hover bg-dark-surface text-neon-cyan focus:ring-neon-cyan">
                  <label for="embed-title" class="text-sm text-text-primary">Show game title</label>
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="embed-platforms" checked class="w-4 h-4 rounded border-dark-card-hover bg-dark-surface text-neon-cyan focus:ring-neon-cyan">
                  <label for="embed-platforms" class="text-sm text-text-primary">Show platforms</label>
                </div>
              </div>

              <!-- Embed Code -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <label class="block text-sm font-medium text-text-primary">Embed Code</label>
                  <button
                    id="copy-embed-code"
                    class="px-4 py-2 bg-neon-cyan hover:bg-neon-purple text-dark-bg rounded-lg text-sm font-semibold transition-colors"
                  >
                    Copy Code
                  </button>
                </div>
                <textarea
                  id="embed-code"
                  readonly
                  class="w-full px-4 py-3 bg-dark-surface border border-dark-card-hover rounded-lg text-text-primary font-mono text-sm resize-none"
                  rows="4"
                ></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Platforms -->
        <div class="flex flex-wrap items-center justify-center gap-3 mb-8 animate-fade-in" style="animation-delay: 0.8s;">
          {game.platforms.map((platform) => (
            <PlatformTag platform={platform} />
          ))}
        </div>

        <!-- Back to Home -->
        <a
          href="/"
          class="inline-flex items-center gap-2 text-text-secondary hover:text-neon-cyan transition-colors duration-200 text-sm animate-fade-in"
          style="animation-delay: 1s;"
          data-astro-prefetch
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          Back to Games
        </a>
      </div>
    </section>
  </div>
</MainLayout>

<script define:vars={{ gameSlug: game.slug, shareUrl, gameUrl, gameData: JSON.stringify(game) }}>
  // Platform selector functionality
  function initPlatformSelector() {
    const platformButtons = document.querySelectorAll('.platform-select-btn');
    const countdownTimer = document.getElementById('main-countdown');
    const releaseDateDisplay = document.getElementById('release-date-display');
    const game = JSON.parse(gameData);
    
    if (platformButtons.length === 0) return;
    
    // Set first platform as active by default
    if (platformButtons.length > 0) {
      platformButtons[0].classList.add('bg-neon-cyan/20', 'border-neon-cyan', 'text-neon-cyan');
      platformButtons[0].classList.remove('bg-dark-card/50', 'text-text-secondary');
    }
    
    platformButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const platform = btn.getAttribute('data-platform');
        const releaseDate = btn.getAttribute('data-release-date');
        
        if (!releaseDate) return;
        
        // Update active button
        platformButtons.forEach(b => {
          b.classList.remove('bg-neon-cyan/20', 'border-neon-cyan', 'text-neon-cyan');
          b.classList.add('bg-dark-card/50', 'text-text-secondary');
        });
        btn.classList.add('bg-neon-cyan/20', 'border-neon-cyan', 'text-neon-cyan');
        btn.classList.remove('bg-dark-card/50', 'text-text-secondary');
        
        // Update countdown timer
        if (countdownTimer) {
          const timerElement = countdownTimer.querySelector('[data-release-date]');
          if (timerElement) {
            timerElement.setAttribute('data-release-date', releaseDate);
            // Trigger update
            const event = new CustomEvent('updateTimer', { detail: { releaseDate } });
            window.dispatchEvent(event);
          }
        }
        
        // Update release date display
        if (releaseDateDisplay) {
          const date = new Date(releaseDate);
          releaseDateDisplay.textContent = date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
        }
      });
    });
  }

  // Wishlist functionality (now with Supabase)
  async function initWishlist() {
    const wishlistBtn = document.getElementById('wishlist-btn');
    const wishlistIcon = document.getElementById('wishlist-icon');
    const wishlistText = document.getElementById('wishlist-text');
    const wishlistCountEl = document.getElementById('wishlist-count')?.querySelector('[data-count]');
    
    if (!wishlistBtn || !wishlistIcon || !wishlistText) return;

    // Get anonymous user ID
    function getOrCreateAnonymousUserId() {
      const storageKey = 'droptimer-anonymous-id';
      let userId = localStorage.getItem(storageKey);
      if (!userId) {
        userId = `anon_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
        localStorage.setItem(storageKey, userId);
      }
      return userId;
    }

    const userId = getOrCreateAnonymousUserId();

    // Load wishlist status from API
    async function loadWishlistStatus() {
      try {
        const response = await fetch(`/api/interactions/${gameSlug}?user_id=${userId}`);
        if (!response.ok) return { hasWishlisted: false, count: 0 };
        const data = await response.json();
        return {
          hasWishlisted: data.user_has_wishlisted || false,
          count: data.wishlist_count || 0,
        };
      } catch (error) {
        console.error('Error loading wishlist status:', error);
        // Fallback to localStorage
        try {
          const wishlist = JSON.parse(localStorage.getItem('droptimer-wishlist') || '[]');
          return {
            hasWishlisted: wishlist.includes(gameSlug),
            count: 0,
          };
        } catch {
          return { hasWishlisted: false, count: 0 };
        }
      }
    }

    // Update button state
    function updateButtonState(hasWishlisted, count) {
      if (hasWishlisted) {
        wishlistIcon.classList.add('fill-neon-purple', 'text-neon-purple');
        wishlistText.textContent = 'In Wishlist';
      } else {
        wishlistIcon.classList.remove('fill-neon-purple', 'text-neon-purple');
        wishlistText.textContent = 'Add to Wishlist';
      }
      if (wishlistCountEl) {
        wishlistCountEl.textContent = count;
      }
    }

    // Load initial state
    const { hasWishlisted, count } = await loadWishlistStatus();
    updateButtonState(hasWishlisted, count);

    // Toggle wishlist on click
    wishlistBtn.addEventListener('click', async () => {
      const currentStatus = await loadWishlistStatus();
      const newStatus = !currentStatus.hasWishlisted;
      
      try {
        const method = newStatus ? 'POST' : 'DELETE';
        const url = newStatus 
          ? `/api/interactions/${gameSlug}`
          : `/api/interactions/${gameSlug}?user_id=${userId}`;
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
          },
          body: method === 'POST' ? JSON.stringify({
            user_id: userId,
          }) : undefined,
        });

        if (response.ok) {
          const updatedStatus = await loadWishlistStatus();
          updateButtonState(updatedStatus.hasWishlisted, updatedStatus.count);
          // Also update localStorage as backup
          const wishlist = JSON.parse(localStorage.getItem('droptimer-wishlist') || '[]');
          if (newStatus && !wishlist.includes(gameSlug)) {
            wishlist.push(gameSlug);
          } else if (!newStatus) {
            const index = wishlist.indexOf(gameSlug);
            if (index > -1) wishlist.splice(index, 1);
          }
          localStorage.setItem('droptimer-wishlist', JSON.stringify(wishlist));
          
          // Update wishlist counter in header
          const event = new CustomEvent('wishlist-updated');
          window.dispatchEvent(event);
        }
      } catch (error) {
        console.error('Error toggling wishlist:', error);
      }
    });
  }

  // Share functionality
  function initShare() {
    const shareBtn = document.getElementById('share-btn');
    if (!shareBtn) return;

    shareBtn.addEventListener('click', async () => {
      const shareData = {
        title: document.title,
        text: `Check out the countdown for ${document.querySelector('h1')?.textContent || 'this game'}!`,
        url: shareUrl,
      };

      try {
        // Try Web Share API first (mobile)
        if (navigator.share) {
          await navigator.share(shareData);
        } else {
          // Fallback: Copy to clipboard
          await navigator.clipboard.writeText(shareUrl);
          const originalText = shareBtn.innerHTML;
          shareBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copied!';
          setTimeout(() => {
            shareBtn.innerHTML = originalText;
          }, 2000);
        }
      } catch (err) {
        // User cancelled or error occurred
        if (err.name !== 'AbortError') {
          console.error('Error sharing:', err);
        }
      }
    });
  }

  // Embed functionality
  function initEmbed() {
    const embedBtn = document.getElementById('embed-btn');
    const embedModal = document.getElementById('embed-modal');
    const closeModal = document.getElementById('close-embed-modal');
    const embedSize = document.getElementById('embed-size');
    const embedTheme = document.getElementById('embed-theme');
    const embedTitle = document.getElementById('embed-title');
    const embedPlatforms = document.getElementById('embed-platforms');
    const embedPreview = document.getElementById('embed-preview');
    const embedCode = document.getElementById('embed-code');
    const copyBtn = document.getElementById('copy-embed-code');

    if (!embedBtn || !embedModal) return;

    // Generate embed URL
    function generateEmbedUrl() {
      const size = embedSize?.value || 'medium';
      const theme = embedTheme?.value || 'dark';
      const title = embedTitle?.checked !== false ? 'true' : 'false';
      const platforms = embedPlatforms?.checked !== false ? 'true' : 'false';
      
      return `${gameUrl.replace('/' + gameSlug, '/embed/' + gameSlug)}?size=${size}&theme=${theme}&title=${title}&platforms=${platforms}`;
    }

    // Generate embed code
    function generateEmbedCode() {
      const url = generateEmbedUrl();
      return `<iframe src="${url}" width="100%" height="400" frameborder="0" allowtransparency="true"></iframe>`;
    }

    // Update preview and code
    function updateEmbed() {
      const url = generateEmbedUrl();
      const code = generateEmbedCode();
      
      if (embedPreview) {
        embedPreview.src = url;
      }
      if (embedCode) {
        embedCode.value = code;
      }
    }

    // Open modal
    embedBtn.addEventListener('click', () => {
      if (embedModal) {
        embedModal.classList.remove('hidden');
        updateEmbed();
      }
    });

    // Close modal
    if (closeModal) {
      closeModal.addEventListener('click', () => {
        if (embedModal) {
          embedModal.classList.add('hidden');
        }
      });
    }

    // Close on outside click
    if (embedModal) {
      embedModal.addEventListener('click', (e) => {
        if (e.target === embedModal) {
          embedModal.classList.add('hidden');
        }
      });
    }

    // Update on option change
    [embedSize, embedTheme, embedTitle, embedPlatforms].forEach(element => {
      if (element) {
        element.addEventListener('change', updateEmbed);
      }
    });

    // Copy code
    if (copyBtn && embedCode) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(embedCode.value);
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('bg-green-500');
          copyBtn.classList.remove('bg-neon-cyan');
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove('bg-green-500');
            copyBtn.classList.add('bg-neon-cyan');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          // Fallback: select text
          embedCode.select();
          document.execCommand('copy');
        }
      });
    }
  }

  // Initialize on page load
  if (typeof window !== 'undefined') {
    initPlatformSelector();
    initWishlist();
    initShare();
    initEmbed();
  }
</script>
